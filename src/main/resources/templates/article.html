<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${title} + '-Java资料下载'"></title>
<link rel="stylesheet" type="text/css" href="/layui/css/layui.css" />
<link rel="stylesheet" type="text/css" href="/css/css.css" />
</head>
<body onload="ResizeImages()">
<div class="w1170" th:include="common/head::#h" style="padding-bottom: 10px;overflow:visible;"></div>
<div class="w1170">

    <div class="pLeft">
        <div class="data_list">
            <div class="data_list_title">
                <i class="layui-icon layui-icon-app"></i>
                <span class="head">帖子信息</span>
            </div>
            <div class="article">
                <div class="title" th:text="${article.name}"></div>
                <div class="info">
                    <a href="" target="_blank" th:text="${article.user.userName}"></a>&nbsp;&nbsp;
                    分享于&nbsp;&nbsp;<font th:text="${#dates.format(article.publishDate,'yyyy-MM-dd')}"></font>
                    &nbsp;&nbsp;查看次数：&nbsp;<font th:text="${article.view+' 次'}"></font>
                    &nbsp;&nbsp;所需：<font color="red" th:text="${article.points}"></font>&nbsp;积分
                </div>
                <div align="center">
                    <div class="bshare-custom"><a title="分享到QQ空间" class="bshare-qzone"></a><a title="分享到新浪微博" class="bshare-sinaminiblog"></a><a title="分享到人人网" class="bshare-renren"></a><a title="分享到腾讯微博" class="bshare-qqmb"></a><a title="分享到网易微博" class="bshare-neteasemb"></a><a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a><span class="BSHARE_COUNT bshare-share-count">0</span></div><script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=&amp;pophcol=2&amp;lang=zh"></script><script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
                </div>
                <div class="downloadBtn">
                    <button class="layui-btn layui-btn-radius" onclick="download()">&nbsp;&nbsp;立即下载&nbsp;&nbsp;</button>
                    <button class="layui-btn layui-btn-radius" onclick="vipDownload()" style="background-color: red">&nbsp;&nbsp;VIP免积分下载&nbsp;&nbsp;</button>
                </div>

                <div id="content" class="content" th:utext="${article.content}"></div>
            </div>
        </div>

        <div class="data_list" style="margin-top: 10px">
            <div class="data_list_title">
                <i class="layui-icon layui-icon-dialogue"></i>
                <span class="head">评论信息</span>
            </div>
            <div id="userComment" class="userComment">
                <textarea id="commentContent" placeholder="请输入评论信息" class="layui-textarea"></textarea>
                <button class="layui-btn layui-btn-radius  layui-btn-sm" onclick="submitData()">&nbsp;&nbsp;提交评论&nbsp;&nbsp;</button>
            </div>
        </div>
    </div>

    <div class="pRight">
        <div class="data_list">
            <div class="data_list_title">
                <i class="layui-icon layui-icon-face-smile-fine"></i>
                <span class="head">每日签到，每日领取3个积分</span>
            </div>
            <div align="center">
                <a onclick="sign()"><img style="padding-top: 10px;padding-bottom: 10px" width="200" height="50" alt="用户签到处" src="/static/images/sign.jpg" /></a>


                <p style="padding-bottom: 10px">今日已经有<font color="red">12</font>位大佬签到了！</p>
            </div>
        </div>


        <div class="data_list">
            <div class="data_list_title">
                <i class="layui-icon layui-icon-fire"></i>
                <span class="head">热门资源</span>
            </div>
            <div class="datas">
                <ul>
                    <li th:each="hotArticle:${hotArticleList}">
                        <a target="_blank" th:href="'/article/' + ${hotArticle.id}" th:title="${hotArticle.name}" th:text="${#strings.length(hotArticle.name) > 20} ? ${#strings.substring(hotArticle.name, 0, 21)} : ${hotArticle.name}"></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="w1170" th:include="common/link::#h"></div>

<div class="w960" style="padding-top: 40px" th:include="common/foot::#h"></div>

<script src="/layui/layui.js"></script>
<script src="/js/jquery.js"></script>
<script src="/js/common.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    layui.use(['element','laypage','form'], function(){
        var element = layui.element; //导航的hover效果、二级菜单等功能，需要依赖element模块
        var tMenu = [[${session.tMenu}]];
        $("#"+tMenu).css("color", "red");
    });

    function vipDownload(){
        // 判断是否登录
        if([[${session.currentUser}]]==null){
            layer.msg("登录后才能下载资源！");
            return;
        }

        $.post("/user/isVip",{},function(result){
            if(result){

                // 判断是否下载过
                // 添加记录
                $.post("/user/userDownload/exist",{"id":[[${article.id}]]},function(result){
                    if(result){ // 下载过
                        layer.confirm('该资您已经下载过,您确定要下载这个资源吗？', {
                            title:"下载提示"
                            ,btn: ['确定','取消'] //按钮
                        }, function(){
                            layer.closeAll('dialog');
                            layer.open({
                                type: 2,
                                title: '资源下载页面',
                                shadeClose: true,
                                shade: 0.8,
                                area: ['550px', '450'],
                                content: '/user/article/toVipDownLoadPage/[[${article.id}]]' //iframe的url
                            });
                        }, function(){

                        });
                    }else{  // 未下载过



                        layer.confirm('您确定要下载这个资源吗？', {
                            title:"下载提示"
                            ,btn: ['确定','取消'] //按钮
                        }, function(){
                            layer.closeAll('dialog');
                            layer.open({
                                type: 2,
                                title: '资源下载页面',
                                shadeClose: true,
                                shade: 0.8,
                                area: ['550px', '450'],
                                content: '/user/article/toVipDownLoadPage/[[${article.id}]]' //iframe的url
                            });

                        }, function(){

                        });


                    }
                },"json");


            }else{
                layer.msg("sorry,您不是VIP用户，不能用此通道！");
            }
        },"json");
    }

    function submitData(){
        // 下载过这个资源才可以评论

        if([[${session.currentUser}]]==null){
            layer.msg("登录后才能评论！");
            return;
        }

        // 判断是否下载过
        // 添加记录
        $.post("/user/userDownload/exist",{"id":[[${article.id}]]},function(result){
            if(result){ // 下载过

                var content=$("#commentContent").val();
                if(content==""){
                    layer.msg("请输入评论信息！");
                    return;
                }
                $.post("/user/comment/save",{"article.id":[[${article.id}]],"content":content},function(result){
                    if(result.success){
                        $("#commentContent").val("");
                        layer.msg("评论成功，稍后显示！");
                    }
                },"json");

            }else{  // 未下载过
                layer.msg("下载该资源后才能评论！");
            }
        },"json");
    }

    function download(){

        // 判断是否登录
        if([[${session.currentUser}]]==null){
            layer.msg("登录后才能下载资源！");
            return;
        }

        // 判断是否下载过
        // 添加记录
        $.post("/user/userDownload/exist",{"id":[[${article.id}]]},function(result){
            if(result){ // 下载过
                layer.confirm('该资您已经下载过，再下载不需要扣除积分,您确定要下载这个资源吗？', {
                    title:"下载提示"
                    ,btn: ['确定','取消'] //按钮
                }, function(){
                    layer.closeAll('dialog');
                    layer.open({
                        type: 2,
                        title: '资源下载页面',
                        shadeClose: true,
                        shade: 0.8,
                        area: ['550px', '450'],
                        content: '/user/article/toDownLoadPage/[[${article.id}]]' //iframe的url
                    });
                }, function(){

                });
            }else{  // 未下载过

                // 添加记录
                $.post("/user/userDownload/enough",{"points":[[${article.points}]]},function(result){
                    if(result){  // 积分足够

                        layer.confirm('该资源下载需要 <font color="red">[[${article.points}]]</font> 积分,您确定要下载这个资源吗？', {
                            title:"下载提示"
                            ,btn: ['确定','取消'] //按钮
                        }, function(){
                            layer.closeAll('dialog');
                            layer.open({
                                type: 2,
                                title: '资源下载页面',
                                shadeClose: true,
                                shade: 0.8,
                                area: ['550px', '450'],
                                content: '/user/article/toDownLoadPage/[[${article.id}]]' //iframe的url
                            });

                        }, function(){

                        });

                    }else{ // 积分不够
                        layer.msg("sorry，您的积分不够，不能下载该资源！");
                        return;
                    }
                },"json");


            }
        },"json");
    }
    /*]]>*/
</script>
</body>
</html>